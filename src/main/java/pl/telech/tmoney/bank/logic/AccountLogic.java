package pl.telech.tmoney.bank.logic;

import java.time.LocalDate;
import java.util.List;
import java.util.stream.Collectors;

import javax.annotation.PostConstruct;

import org.apache.commons.lang3.tuple.Pair;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.validation.BeanPropertyBindingResult;
import org.springframework.validation.Errors;

import lombok.RequiredArgsConstructor;
import pl.telech.tmoney.bank.dao.AccountDAO;
import pl.telech.tmoney.bank.dao.EntryDAO;
import pl.telech.tmoney.bank.logic.validator.AccountValidator;
import pl.telech.tmoney.bank.mapper.AccountMapper;
import pl.telech.tmoney.bank.model.dto.AccountDto;
import pl.telech.tmoney.bank.model.entity.Account;
import pl.telech.tmoney.bank.model.entity.Entry;
import pl.telech.tmoney.commons.logic.AbstractLogic;
import pl.telech.tmoney.commons.model.exception.ValidationException;
import pl.telech.tmoney.commons.model.shared.TableParams;

@Service
@Transactional
@RequiredArgsConstructor
public class AccountLogic extends AbstractLogic<Account> {
	
	private static final Account summaryAccount;
	
	final AccountDAO dao;
	final EntryDAO entryDao; //TODO wywaliÄ‡
	final AccountMapper mapper;
	final AccountValidator validator;

	
	static {
		summaryAccount = new Account();
		summaryAccount.setActive(true);
		summaryAccount.setCode(Account.SUMMARY_CODE);
		summaryAccount.setName("Podsumowanie");
		summaryAccount.setLogo("data:image/jpeg;base64,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");
	}
	
	@PostConstruct
	public void init() {
		super.dao = this.dao;
	}
	
	public Pair<List<Account>, Integer> loadTable(TableParams params) {
		return dao.findTable(params);
	}
	
	public Account loadByCode(String code) {
		return dao.findByCode(code);
	}
	
	public Account getSummaryAccount() {
		return summaryAccount;
	}
	
	public List<Account> loadAll(boolean active) {
		return dao.findAll(active);
	}
	
	public Account create(AccountDto accountDto) {
		Account newAccount = mapper.create(accountDto);
		
		Errors errors = new BeanPropertyBindingResult(newAccount, "Konto");
		validator.validate(newAccount, errors);
		if (errors.hasErrors()) {
			throw new ValidationException(errors.getAllErrors());
		}
		
		return save(newAccount);
	}
	
	public Account update(int id, AccountDto accountDto) {
		Account account = loadById(id);			
		mapper.update(account, accountDto);
		return save(account);
	}
	
	public List<Pair<Account, Entry>> getAccountSummaries(String accountCode) {	
		List<String> accountCodes = accountCode != null
				? List.of(accountCode)
				: dao.findAll(true).stream().map(Account::getCode).collect(Collectors.toList());
		
		return getAccountSummaries(accountCodes);
	}
	
	private List<Pair<Account, Entry>> getAccountSummaries(List<String> accountCodes) {
		return accountCodes.stream()
				.map(code -> {
					var account = dao.findByCode(code);
					Entry entry = entryDao.findLastByAccountBeforeDate(account.getId(), LocalDate.now().plusDays(1));
					return Pair.of(account, entry);
				})
				.collect(Collectors.toList());
	}
}
